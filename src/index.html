<html>
    <head>
        <title>EmulatorJS | Netplay Server</title>
        <link rel="icon" type="image/png" href="img/icon.ico">
        <style>
            body {
                background-color: black;
                color: white;
            }

            .loading-screen {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                color: white;
                text-align: center;
                opacity: 1;
                transition: opacity 1s ease-in-out;
                z-index: 1;
            }

            .content {
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                opacity: 0;
                transition: opacity 1s ease-in-out;
                z-index: 2;
                text-align: center;
            }

            .loading-logo {
                width: 350px;
                height: 350px;
                filter: drop-shadow(0 0 20px white);
            }

            .logo {
                width: 200px;
                height: 200px;
                filter: drop-shadow(0 0 10px white);
            }

            .loading-text {
                font-size: 24px;
                filter: drop-shadow(0 0 10px white);
            }

            .button {
                background-color: #0098C5;
                color: #000;
                font-size: 18px;
                border: none;
                border-radius: 5px;
                padding: 5px 10px;
                cursor: pointer;
            }

            .button:hover {
                background-color: #006888;
            }

            #status,
            #nuser {
                margin: 10px 0;
            }

            .url-list {
                padding: 0;
                display: inline-block;
                text-align: left;
                margin: 0;
            }

            .url-list li {
                margin-bottom: 2px;
            }

            a {
                color: #0098C5;
                text-decoration: none;
            }

            a:hover {
                text-decoration: underline;
            }

            * {
                scrollbar-width: auto;
                scrollbar-color: #0097c5 #000000;
            }

            *::-webkit-scrollbar {
                width: 10px;
            }

            *::-webkit-scrollbar-track {
                background: #000000;
            }

            *::-webkit-scrollbar-thumb {
                background-color: #0097c5;
                border-radius: 10px;
                border: 0.5px solid #006888;
            }
        </style>
    </head>
    <body>
        <div id="loading" class="loading-screen">
            <img src="./img/logo-light.png" alt="Logo" class="loading-logo">
            <p class="loading-text">Loading Server...</p>
          </div>
        
          <div id="content" class="content">
            <h1>EmulatorJS Netplay Server</h1>
            <img src="img/logo-light.png" alt="Logo" class="logo">
            <p id="info">Server info</p>
            <button onclick="server()" id="server" class="button">Start Server</button>
            <p id="status"></p>
            <p id="nuser"></p>
            <p>URL's to use with EmulatorJS Netplay: <ul id="urls" class="url-list"></ul></p>
            <p><a href="https://github.com/EmulatorJS/EmulatorJS-Netplay" target="_blank" class="github-link">View on GitHub</a></p>
            <p>Licensed under the Apache License 2.0 - Read the license <a href="https://github.com/EmulatorJS/EmulatorJS-Netplay/blob/main/LICENSE" target="_blank" class="license-link">here</a></p>
            <br>
          </div>
        <script> 
            const startstop = document.getElementById('server');
            window.addEventListener("load", function() {
                const loadingScreen = document.getElementById("loading");
                const content = document.getElementById("content");
                setTimeout(function() {
                    loadingScreen.style.opacity = 0;
                    content.style.opacity = 1;
                }, 1000);
                setTimeout(function() {
                    loadingScreen.remove();
                }, 2000);
            });

            (function() {
                check();
                status().then(info => {
                    document.getElementById('info').innerHTML = "Running server on port " + (info.port || 3000) + " with password " + info.password;
                });
                interface().then(address => {
                    address.interfaces.push(window.location.protocol+"//"+window.location.hostname+':'+window.location.port+'/');
                    address.interfaces = [...new Set(address.interfaces)];
                    address.interfaces.forEach(address => {
                        document.getElementById('urls').innerHTML += '<li><a href="'+address+'" target="_blank" onclick="window.api.openExternal(this.href);event.preventDefault()">'+address+'</a></li>';
                    });
                });
                checkforusers();
            })();

            function status() {
                return fetch('/status', {
                    method: 'POST',
                    headers: {
                    'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    return data;
                });
            }

            function interface() {
                return fetch('/interface', {
                    method: 'POST',
                    headers: {
                    'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    return data;
                });
            }
            function check(){
                fetch('/check', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                }).then(response => response.json())
                    .then(data => {
                    if(data == true){
                        startstop.innerText = 'Stop';
                    }else if(data == false){
                        startstop.innerText = 'Start';
                    }
                    update();
                });
            }
            function update(){
                if(startstop.textContent == "Start"){
                    document.getElementById('status').style.color = "red";
                    document.getElementById('status').innerText = 'NOT RUNNING';
                }else if(startstop.textContent == "Stop"){
                    document.getElementById('status').style.color = "green";
                    document.getElementById('status').innerText = 'RUNNING';
                }else{
                    console.error("Error!");	
                }
            }
            function server(){
                if (startstop.textContent === 'Start'){
                    startstopserver("start");
                    while(startstop.textContent === 'Start'){
                        check();
                    }
                }else if(startstop.textContent === 'Stop'){
                    startstopserver("stop");
                    while(startstop.textContent === 'Stop'){
                        check();
                    }
                }
                update();
            }
            function startstopserver(option){
                fetch('/startstop', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        function: option,
                    })
                }).then(response => response.json())
                    .then(data => {
                    if(option == "start"){
                        if(data == true){
                            startstop.innerText = 'Stop'; 
                        }else{
                            console.error("There was error starting the server!");
                        }	
                    }else if(option == "stop"){
                        if(data == true){
                            startstop.innerText = 'Start'; 
                        }else{
                            console.error("There was error stoping the server!");
                        }
                    }else{
                        console.error("Error!");	
                    }
                    update();
                });
            }
            setInterval(function(){ 
                checkforusers();
            }, 5000);
            function checkforusers(){
                fetch('/numusers', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    }
                }).then(response => response.json())
                    .then(data => {
                    data = data.users;
                    document.getElementById('nuser').innerHTML = "Users connected: "+data;
                });	
            }
        </script>
    </body>
</html>
